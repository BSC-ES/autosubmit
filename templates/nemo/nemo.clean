set -exuv
date
#
# General Paths
#
SCRATCH_DIR=%SCRATCH_DIR%
HSM_DIR=%HSM_DIR%
NCOPATH="%NCOPATH%"
#
# Model Configuration
#
EXPID=%EXPID%
MEMBER=%MEMBER%
START_date=%SDATE%
<<<<<<< HEAD
WRITINGDIR=${SCRATCH_DIR}/%HPCUSER%/${EXPID}
RUN_dir=${WRITINGDIR}/${START_date}/${MEMBER}
=======
WRITINGDIR=${SCRATCH_DIR}/%HPCPROJ%/%HPCUSER%/${EXPID}
RUN_dir=${WRITINGDIR}/${MEMBER}
>>>>>>> develop-projects
PATHOUT="${HSM_DIR}/exp/${EXPID}/${MEMBER}"
PATHFORC=${HSM_DIR}/fg/ocean/%OCEAN_FORCTYPE%
PATHNUDG=${HSM_DIR}/nudging/%OCEAN_NUDDATA%/${MEMBER}
PATHIC=${HSM_DIR}/ic
#
# Chunk management
#
chunk=%CHUNK%
Chunk_last=%Chunk_LAST%
Chunk_start_date=%Chunk_START_DATE%
Chunk_end_date=%Chunk_END_DATE%
RUN_year=`echo ${Chunk_start_date} | cut -c1-4`
Chunk_start_month=`echo ${Chunk_start_date} | cut -c5-6`
Chunk_end_month=`echo ${Chunk_end_date} | cut -c5-6`
if [[ %OCEAN_FORCYEAR% == -1 && %OCEAN_FORCTYPE% == 'eraint' ]] ; then
  RUN_days=%RUN_DAYS%
  day_prev=%PREV%
else
  Chunk_length_month=$((${Chunk_end_month}-${Chunk_start_month}+1))
  case ${Chunk_length_month} in
    6)
    case ${Chunk_start_month} in
      01) RUN_days=181
      day_prev=$(( ( (chunk-1) / 2 ) * 365 ))
      ;;
      07) RUN_days=184
      day_prev=$(( ( (chunk-1) / 2 ) * 365 + 181 ))
      ;;
    esac
    ;;
    12) RUN_days=365
    day_prev=$(( (chunk-1) * 365 ))
    ;;
  esac
fi
Chunk_length=$(( ${RUN_days} * 24 )) # In hours
Chunk_last_day_prev=$(( ${day_prev} * 24 )) # In hours
#
###############################################################################
#                               SAVE RESTARTS                                 # 
###############################################################################
#
PATHOUT_RES="${PATHOUT}/restarts"
mkdir -p ${PATHOUT_RES}               # Where the restarts are to be stored
#
rstdir="${RUN_dir}/NEMO_Restart_${chunk}"
listfile=""
if [[ -d ${rstdir} ]] ; then
  cd ${rstdir}
  if [[ -e ${EXPID}_${MEMBER}_${Chunk_end_date}_restart.nc || -e ORCA1_${Chunk_end_date}_restart_0000.nc ]] ; then
    listfile=`ls *_restart*.nc`
  fi
else
  exit 1
fi                                    # Which restarts to store
#
tarfile="restart_${EXPID}_${START_date}_${MEMBER}_${Chunk_start_date}-${Chunk_end_date}.tar"
if [[ ! -e $tarfile ]] ; then
  tar -cvf $tarfile ${listfile}
  cp $tarfile $PATHOUT_RES              # Store
  #
  locfile=`md5sum ${tarfile}|cut -d" " -f1`              
  remfile=`md5sum ${PATHOUT_RES}/${tarfile}|cut -d" " -f1`
  if [[ "$locfile" == "$remfile" ]] ; then
    echo "The file has been correctly stored"
  else
    exit 1
  fi
fi                                     # Check if the storage is ok before rm
#
if [[ %OCEAN_ALLRST% == 'TRUE' ]] ; then
#                                      # Save restarts as new initial cond. 
  if [[ ${listfile} != "" ]] ; then gzip ${listfile} ; fi
  restarts_ocean=`ls *restart.nc.gz`
  restarts_ice=`ls *restart_ice.nc.gz`
  mkdir -p $PATHIC/ocean/${EXPID}
  mkdir -p $PATHIC/ice/${EXPID}
  cp $restarts_ocean $PATHIC/ocean/${EXPID}/.  
  cp $restarts_ice $PATHIC/ice/${EXPID}/.
#
fi
#
###############################################################################
#                               SAVE OUTPUTS                                  #
###############################################################################
#
PATHOUT_OUT="${PATHOUT}/outputs"
mkdir -p ${PATHOUT_OUT}                # Where the outputs are to be stored
#
output_dir=${RUN_dir}/Output_${chunk}
if [[ -d ${output_dir} ]] ; then
  cd ${output_dir}
  if [[ %OCEAN_REDUCOUT% == 'TRUE' ]] ; then
    listfile2=`ls sstsssmld*.nc ice*.nc t3d*.nc sal*.nc heat*.nc moc*.nc psi*.nc `
    tarfile="diags_${EXPID}_${START_date}_${MEMBER}_${Chunk_start_date}-${Chunk_end_date}.tar"
  else
    listfile2=`ls *grid_T.nc *grid_V.nc *grid_U.nc *grid_W.nc *icemod.nc`
    tarfile="MMO_${EXPID}_${START_date}_${MEMBER}_${Chunk_start_date}-${Chunk_end_date}.tar"
  fi
else
  exit 1
fi                                   
#
tar -cvf $tarfile ${listfile2}
cp $tarfile $PATHOUT_OUT              # Store
#
locfile=`md5sum ${tarfile}|cut -d" " -f1`
remfile=`md5sum ${PATHOUT_OUT}/${tarfile}|cut -d" " -f1`
if [[ "$locfile" == "$remfile" ]] ; then
  echo "The file has been correctly stored"
  rm -f ../$tarfile
else
  exit 1
fi                                    # Check if the storage is ok before rm
#
################################################################################
#                            PREPARE NEXT FORCINGS                             #
################################################################################
#
cd ${RUN_dir}
#
if [[ %OCEAN_FORCYEAR% == -1 ]]; then
  FORCING_YEAR=$RUN_year
else
  FORCING_YEAR=%OCEAN_FORCYEAR%
fi

listvars=( q2 qlw qsw t2 u10 v10 snow precip )

type=%OCEAN_FORCTYPE%
if [ %OCEAN_FORCYEAR% == -1 ] ; then
  for var in ${listvars[@]} ; do
    case $var in
      'u10'|'v10') midname=${MEMBER}_${type} ;;
      *) midname=${type} ;;
    esac
    if [[ -e ${var}_core_y$((RUN_year-2)).nc ]] ; then
      rm -f ${var}_core_y$((RUN_year-2)).nc
    fi
    if [[ -e ${PATHFORC}/${var}_${midname}_$((FORCING_YEAR+3)).nc ]] ; then
      cp ${PATHFORC}/${var}_${midname}_$((FORCING_YEAR+3)).nc ${var}_core_y$((RUN_year+3)).nc
    else
      cp ${var}_core_y$((RUN_year+2)).nc ${var}_core_y$((RUN_year+3)).nc
    fi
  done
fi
#
################################################################################
#                          PREPARE NEXT NUDGING FILES                          #
################################################################################
#
if [[ %OCEAN_NUDGING% == 'TRUE' ]] ; then

  case ${Chunk_start_month} in
    01)
    ${NCOPATH}/ncks -O -d time_counter,9,11 nudg_chunk$((chunk+1)).nc nudg_chunk$((chunk+2))_10-12.nc
    ${NCOPATH}/ncks -O -d time_counter,0,2 nudg_chunk$((chunk+1)).nc nudg_chunk$((chunk+2))_1-3.nc
    for ((mon=4;mon<=9;mon++)) ; do
      if [[ -e ${PATHNUDG}/%OCEAN_NUDDATA%_${MEMBER}_$((RUN_year+1))0${mon}_grid_T.nc.gz ]] ; then
        cp ${PATHNUDG}/%OCEAN_NUDDATA%_${MEMBER}_$((RUN_year+1))0${mon}_grid_T.nc.gz nudg_chunk$((chunk+2))_0${mon}.nc.gz
        gunzip -f nudg_chunk$((chunk+2))_0${mon}.nc.gz
      else
        ${NCOPATH}/ncks -O -d time_counter,$((mon-1)) nudg_chunk$((chunk+1)).nc nudg_chunk$((chunk+2))_0${mon}.nc
      fi
    done
    ${NCOPATH}/ncrcat -O -v votemper,vosaline -n 6,2,1 nudg_chunk$((chunk+2))_04.nc nudg_chunk$((chunk+2))_4-9.nc
    ;;
    07)
    ${NCOPATH}/ncks -O -d time_counter,3,8 nudg_chunk$((chunk+1)).nc nudg_chunk$((chunk+2))_4-9.nc
    for ((mon=10;mon<=12;mon++)) ; do
      if [[ -e ${PATHNUDG}/%OCEAN_NUDDATA%_${MEMBER}_$((RUN_year+1))${mon}_grid_T.nc.gz ]] ; then
        cp ${PATHNUDG}/%OCEAN_NUDDATA%_${MEMBER}_$((RUN_year+1))${mon}_grid_T.nc.gz nudg_chunk$((chunk+2))_${mon}.nc.gz
        gunzip -f nudg_chunk$((chunk+2))_${mon}.nc.gz
      else
        ${NCOPATH}/ncks -O -d time_counter,$((mon-1)) nudg_chunk$((chunk+1)).nc nudg_chunk$((chunk+2))_${mon}.nc
      fi
    done
    for ((mon=1;mon<=3;mon++)) ; do
      if [[ -e ${PATHNUDG}/%OCEAN_NUDDATA%_${MEMBER}_$((RUN_year+2))0${mon}_grid_T.nc.gz ]] ; then
        cp ${PATHNUDG}/%OCEAN_NUDDATA%_${MEMBER}_$((RUN_year+2))0${mon}_grid_T.nc.gz nudg_chunk$((chunk+2))_0${mon}.nc.gz
        gunzip -f nudg_chunk$((chunk+2))_0${mon}.nc.gz
      else
        ${NCOPATH}/ncks -O -d time_counter,$((mon-1)) nudg_chunk$((chunk+1)).nc nudg_chunk$((chunk+2))_0${mon}.nc
      fi
    done
    ${NCOPATH}/ncrcat -O -v votemper,vosaline -n 3,2,1 nudg_chunk$((chunk+2))_10.nc nudg_chunk$((chunk+2))_10-12.nc
    ${NCOPATH}/ncrcat -O -v votemper,vosaline -n 3,2,1 nudg_chunk$((chunk+2))_01.nc nudg_chunk$((chunk+2))_1-3.nc
    ;;
    *) echo "not coded yet. Please start date month Jan or Jun" ;;   
  esac
  ${NCOPATH}/ncrcat -O -v votemper,vosaline nudg_chunk$((chunk+2))_1-3.nc nudg_chunk$((chunk+2))_4-9.nc nudg_chunk$((chunk+2))_10-12.nc nudg_chunk$((chunk+2)).nc
  rm -f nudg_chunk$((chunk+2))_*.nc nudg_chunk${chunk}.nc

fi

################################################################################
#                          CLEAN FROM PREVIOUS CHUNK                           #
################################################################################
#
if [ -d ${RUN_dir}/NEMO_Restart_$((chunk-2)) ] ; then
  rm -rf ${RUN_dir}/NEMO_Restart_$((chunk-2))
fi
if [ -d ${RUN_dir}/Output_$((chunk-2)) ] ; then
  rm -rf ${RUN_dir}/Output_$((chunk-2))
fi
#
################################################################################
#                                FINAL CLEANING                                #
################################################################################
#
if [[ $Chunk_last == 'TRUE' ]]; then
  rm -r $RUN_dir
fi

touch %SCRATCH_DIR%/%HPCPROJ%/%HPCUSER%/%EXPID%/LOG_%EXPID%/%JOBNAME%_COMPLETED

date

