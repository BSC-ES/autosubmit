set -evx
date
#
# Defitions of Path
#
SCRATCH_DIR=%SCRATCH_DIR%
HSMdir=%HSMdir%
DBdir=%DBdir%
ECEARTH_DIR=%ECEARTH_DIR%

#
# Basic Definitions
#
VERSION=%VERSION%
MEMBER=%MEMBER%
EXPID=%EXPID%
START_date=%SDATE%
START_date_1=%DAY_BEFORE%
ATM_INI=%ATM_INI%
IFS_resolution=%IFS_resolution%
PATHGRIBAPI=%PATHGRIBAPI%
#
YYTH=2009
case $VERSION in
     v2.1)   ECEARTH=${ECEARTH_DIR}/v2.1
             SCRIPTDIR=${ECEARTH_DIR}/v2.1/setup
             TESTDATADIR=${ECEARTH_DIR}/v2.1/inidata/testdata
     ;;
     v2.2.0) ECEARTH=${ECEARTH_DIR}/v2.2.0
             SCRIPTDIR=${ECEARTH_DIR}/v2.2.0/setup
             TESTDATADIR=${ECEARTH_DIR}/v2.2.0/inidata/testdata
     ;;
     v2.2.1) ECEARTH=${ECEARTH_DIR}/v2.2.1
             SCRIPTDIR=${ECEARTH_DIR}/v2.2.1/setup
             TESTDATADIR=${ECEARTH_DIR}/v2.2.1/inidata/testdata
     ;;
     v2.2.2) ECEARTH=${ECEARTH_DIR}/v2.2.2
             SCRIPTDIR=${ECEARTH_DIR}/v2.2.2/setup
             TESTDATADIR=${ECEARTH_DIR}/v2.2.2/inidata/testdata
             YYTH=2005
     ;;
     v2.2.3) ECEARTH=${ECEARTH_DIR}/v2.2.3
             SCRIPTDIR=${ECEARTH_DIR}/v2.2.3/setup
             TESTDATADIR=${ECEARTH_DIR}/v2.2.3/inidata/testdata
             YYTH=2005
     ;;
esac
#
# Model Configuration
#
PATH=${SCRIPTDIR}:${PATH}
PATH=%NCPATH%:${PATH}
WRITINGDIR=${SCRATCH_DIR}/${USER}/${EXPID}

mkdir -p ${DBdir}/${EXPID}
mkdir -p ${WRITINGDIR}
mkdir -p ${WRITINGDIR}/${START_date}

RUN_dir=${WRITINGDIR}/${START_date}/${MEMBER}
if [[ -d $RUN_dir ]] ; then
   chmod +wx -R $RUN_dir
   rm -rf $RUN_dir
fi
mkdir -p $RUN_dir

# Also create the directory structure on HSM

mkdir -p "${HSMdir}/exp/${EXPID}/${START_date}/${MEMBER}"

cd $RUN_dir
#
# Get initial conditions
#
INIPATH=${RUN_dir}/inidata
mkdir -p $INIPATH

CMIP5=%CMIP5%
POSTP=cmip5
Nrcp=%Nrcp%
if [[ $CMIP5 == TRUE ]]; then
   if [[ $Nrcp == 1 ]]; then
           RCP=3-PD
   fi
   if [[ $Nrcp == 2 ]]; then
           RCP=4.5
   fi
   if [[ $Nrcp == 3 ]]; then
           RCP=6
   fi
   if [[ $Nrcp == 4 ]]; then
           RCP=8.5
   fi
fi

if [[ $CMIP5 = TRUE ]] ; then
   cp -r ${ECEARTH_DIR}/data/${POSTP}/postins ${INIPATH}/.
   cp ${ECEARTH_DIR}/data/${POSTP}/dirlist ${INIPATH}/.
fi
#
# Copies initial conditions from HSM
#

#
# Atmosphere
#

cp ${HSMdir}/ic/atmos/${ATM_INI}/${ATM_INI}_initial_an0_${MEMBER}_${START_date}00.tar ${INIPATH}
cd ${INIPATH}
tar xvf ${ATM_INI}_initial_an0_${MEMBER}_${START_date}00.tar
rm -f ${ATM_INI}_initial_an0_${MEMBER}_${START_date}00.tar
#
# Rename the initial conditions
#
case $VERSION in
     v2.1)   PREFIX_LST="CL GG SH"
     ;;
     v2.2.0) PREFIX_LST="GG SH"
           cp ${TESTDATADIR}/ifs/${IFS_resolution}/ICMCLb0ifINIT ICMCL${EXPID}INIT
     ;;
     v2.2.1) PREFIX_LST="GG SH"
           cp ${TESTDATADIR}/ifs/${IFS_resolution}/ICMCLb0ifINIT ICMCL${EXPID}INIT
     ;;
     v2.2.2) PREFIX_LST="GG SH"
            cp ${ATM_INI}_initial_an0_${MEMBER}_${START_date}00/ICMCL${ATM_INI}INIT ICMCL${EXPID}INIT
     ;;
     v2.2.3) PREFIX_LST="GG SH"
            cp ${ATM_INI}_initial_an0_${MEMBER}_${START_date}00/ICMCL${ATM_INI}INIT ICMCL${EXPID}INIT
     ;;
esac
for PREFIX in $PREFIX_LST ; do
    mv ${ATM_INI}_initial_an0_${MEMBER}_${START_date}00/ICM${PREFIX}${ATM_INI}INIT ICM${PREFIX}${EXPID}INIT
done
mv ${ATM_INI}_initial_an0_${MEMBER}_${START_date}00/ICMGG${ATM_INI}INIUA ICMGG${EXPID}INIUA

#
# Construct an ICMCL file that goes beyond a given year for the appropriate scenario
# Before that year it uses the observational data
#

#cp ${TESTDATADIR}/ifs/${IFS_resolution}/icmcl_rcp_2000_2099/ICMCL_rcp${Myrcp}.grb ICMCL_rcp${Myrcp}.grb.tmp
#cp ICMCL${EXPID}INIT ICMCL${EXPID}INIT.tmp
#YY=1999
#while [[ $YY -le 2011 ]] ; do
#     if [[ $YY -gt YYTH ]] ; then
#        ${PATHGRIBAPI}/grib_copy -w year!=${YY} ICMCL${EXPID}INIT.tmp ICMCL${EXPID}INIT.tmp2
#     else
#        cp ICMCL${EXPID}INIT.tmp ICMCL${EXPID}INIT.tmp2
#     fi
#     if [[ $YY -le YYTH ]] ; then
#        ${PATHGRIBAPI}/grib_copy -w year!=${YY} ICMCL_rcp${Myrcp}.grb.tmp ICMCL_rcp${Myrcp}.grb.tmp2
#     else
#        cp ICMCL_rcp${Myrcp}.grb.tmp ICMCL_rcp${Myrcp}.grb.tmp2
#     fi
#     mv ICMCL${EXPID}INIT.tmp2 ICMCL${EXPID}INIT.tmp
#     mv ICMCL_rcp${Myrcp}.grb.tmp2 ICMCL_rcp${Myrcp}.grb.tmp
#     YY=$((YY+1))
#done
#${PATHGRIBAPI}/grib_copy ICMCL${EXPID}INIT.tmp ICMCL_rcp${Myrcp}.grb.tmp ICMCL${EXPID}INIT
#rm -f ICMCL${EXPID}INIT.tmp ICMCL_rcp${Myrcp}.grb.tmp ICMCL_rcp${Myrcp}.grb

ls -l ${INIPATH}

touch %SCRATCH_DIR%/%HPCUSER%/%EXPID%/LOG_%EXPID%/%JOBNAME%_COMPLETED

date
