set -xuve
date

#
# HPC Arch
#
HPCARCH=%HPCARCH%
case $HPCARCH in
 ecmwf)
  MKDIR="eval emkdir -p"
  CP="eval ecp -o"
  LS="eval els"
  CHMOD="eval echmod 775"
 ;;
 *)
  MKDIR="mkdir -p"
  CP="cp -f"
  LS="ls"
  CHMOD="chmod 775"
 ;;
esac

#
# General Paths
#
SCRATCH_DIR=%SCRATCH_DIR%
HSM_DIR=%HSM_DIR%

#
# Model Configuration
#
EXPID=%EXPID%
MEMBER=%MEMBER%
START_date=%SDATE%
WRITINGDIR=${SCRATCH_DIR}/%HPCUSER%/${EXPID}
RUN_dir=${WRITINGDIR}/${START_date}/${MEMBER}

#
# Chunk Management
#
chunk=%CHUNK%
Chunk_start_date=%Chunk_START_DATE%
Chunk_end_date=%Chunk_END_DATE%
Chunk_last=%Chunk_LAST%
# In months
RUN_months=%CHUNKSIZE%
# In days
RUN_days=%RUN_DAYS%
# In hours
RUN_hours=$((RUN_days*24))

#
# Output Path on HSM (permanent storage)
#
PATHOUT="${HSM_DIR}/exp/${EXPID}/${START_date}/${MEMBER}"
$LS ${PATHOUT}
if [[ $? -ne 0 ]]; then
   echo "HOUSTON we have a problem!"
   echo " this directory should already exist! ${PATHOUT}"
   exit
fi

output_dir=${RUN_dir}/Output_${chunk}
if [[ ! -d ${RUN_dir} ]]; then
   exit
fi
cd $RUN_dir

#
# Prepar restarts (in case, if some chunks need to be rerun or the experiment is to be extend)
#
if [[ ! -d $output_dir ]]; then
   rm -f *_$((chunk+1))
   RESTA="RESTA_${EXPID}_${START_date}_${MEMBER}_${chunk}_${Chunk_start_date}-${Chunk_end_date}.tar"
   RESTO="RESTO_${EXPID}_${START_date}_${MEMBER}_${chunk}_${Chunk_start_date}-${Chunk_end_date}.tar"
   $CP ${PATHOUT}/restarts/$RESTA .; $CP ${PATHOUT}/restarts/$RESTO .
   tar -xvf $RESTA; tar -xvf $RESTO
   rm -f $RESTA $RESTO
   touch %SCRATCH_DIR%/%HPCUSER%/%EXPID%/LOG_%EXPID%/%JOBNAME%_COMPLETED
   exit
fi

#
# Save NEMO & IFS restart files at permanent storage
#
PATHOUT_RES="${PATHOUT}/restarts"
$MKDIR ${PATHOUT_RES}

if [[ ! -a ${RUN_dir}/rest_${chunk} ]]; then

   for REST in RESTA RESTO; do
       case ${REST} in
            RESTA) PATHSU="IFS_Restart_${chunk}"
                   FILEPREF="*"
            ;;
            RESTO) PATHSU="NEMO_Restart_${chunk}"
                   FILEPREF="*"
            ;;
       esac

   # Create and copy tar file
   tarfile="${REST}_${EXPID}_${START_date}_${MEMBER}_${chunk}_${Chunk_start_date}-${Chunk_end_date}.tar"
   tar -cvf $tarfile ${PATHSU}/${FILEPREF}
   $CP $tarfile $PATHOUT_RES
   $CHMOD $PATHOUT_RES/$tarfile
   rm -f $tarfile
   touch ${RUN_dir}/${REST}_${chunk}
   done

   if [[ -a ${RUN_dir}/RESTA_${chunk} && -a ${RUN_dir}/RESTO_${chunk} ]]; then
      rm -f ${RUN_dir}/RESTA_${chunk} ${RUN_dir}/RESTO_${chunk}
      touch ${RUN_dir}/rest_${chunk}
   fi
fi

#
# Save NEMO & IFS output files at permanent storage and clean disk
#
if [[ ! -a ${RUN_dir}/out_$chunk ]]; then

   if [[ ! -d ${output_dir} ]]; then
      exit
   fi
   cd $output_dir

   PATHOUT_OUT="${PATHOUT}/outputs"
   $MKDIR ${PATHOUT_OUT}

   # Save Ocean files
   if [[ ! -a ${RUN_dir}/outo_${chunk} ]]; then
      SAVEDDO=%SAVEDDO%
      tarfile="MMO_${EXPID}_${START_date}_${MEMBER}_${Chunk_start_date}-${Chunk_end_date}.tar"
      touch ../$tarfile

      # Copying the 1d (daily), 5d (5 days), 1m (monthly), or any type of means available
      intervals=`ls -1 ${EXPID}_??_*.nc.gz | cut -d '_' -f 2 | uniq`
      for interval in ${intervals}; do
          grid_types=`ls -1 ${EXPID}_${interval}_*.nc.gz | cut -c 27-32`
          prefix=${EXPID}_${interval}_${Chunk_start_date}_${Chunk_end_date}
          for grid_type in ${grid_types}; do
              output_file=${prefix}_${grid_type}.nc.gz
              tar -rvf ../${tarfile} ${output_file}
          done
      done
      $CP ../$tarfile $PATHOUT_OUT
      $CHMOD $PATHOUT_OUT/$tarfile
      rm -f ../$tarfile
      touch ${RUN_dir}/outo_${chunk}
   fi

   # Save Atmospheric files
   if [[ ! -a ${RUN_dir}/outa_${chunk} ]]; then
      SAVEDD=%SAVEDD%
      tarfile="MMA_${EXPID}_${START_date}_${MEMBER}_${Chunk_start_date}-${Chunk_end_date}.tar"

      # Copying the monthly means
      tar -cvf ../$tarfile MMA_${EXPID}_*.nc.gz
      $CP ../$tarfile $PATHOUT_OUT
      $CHMOD $PATHOUT_OUT/$tarfile
      rm -f ../$tarfile

      # Copying the daily data (GRIB files)
      if [[ $SAVEDD == TRUE ]]; then
         for grbfile in `ls ICM*grb`; do
             $CP $grbfile $PATHOUT_OUT
             $CHMOD $PATHOUT_OUT/$grbfile
             rm -f $grbfile
         done
      fi
      touch ${RUN_dir}/outa_${chunk}
   fi

   if [[ -a ${RUN_dir}/outo_$chunk && -a ${RUN_dir}/outa_$chunk ]]; then
      rm -f ${RUN_dir}/outo_$chunk ${RUN_dir}/outa_$chunk
      touch ${RUN_dir}/out_$chunk
   fi
fi

#
# Tail of the chunk
#
cd $RUN_dir
if [[ -a rest_$chunk && -a out_$chunk ]]; then
   echo "We are now removing ${output_dir}"
   rm -rf $output_dir
fi

touch %SCRATCH_DIR%/%HPCUSER%/%EXPID%/LOG_%EXPID%/%JOBNAME%_COMPLETED

if [[ $Chunk_last == TRUE ]]; then
   cd %SCRATCH_DIR%/%HPCUSER%/%EXPID%/LOG_%EXPID%
   if [[ -a ${RUN_dir}/rest_$((chunk-1)) && -a ${RUN_dir}/out_$((chunk-1)) ]]; then
      echo "We are now removing ${RUN_dir}"
      rm -rf ${RUN_dir}
      touch dir_${EXPID}_${START_date}_${MEMBER}_REMOVED
      touch exp_${EXPID}_${START_date}_${MEMBER}_READY
   fi
   echo "We are now storing log files"
   stamp=`date +%Y%m%d_%H%M`
   tarfile="logfiles_${EXPID}_${START_date}_${MEMBER}_${stamp}.tar"
   set +e
   tar -cvf $tarfile *${EXPID}_${START_date}_${MEMBER}_*
   set -e
   gzip -9 $tarfile
   $CP $tarfile.gz $PATHOUT
   $CHMOD $PATHOUT/*
   rm -f $tarfile.gz
fi

date

